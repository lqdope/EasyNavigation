<!doctype html>
<html lang="ru">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Выбор здания</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-sA+e2m0b0rjv9v+v4gk4Qw1nvQ5wYf5rj6x0kP0Jf6k=" crossorigin="" />
  <style>
    :root {
      --accent: #2563EB;
      --white: #FFFFFF;
      --black: #15171B;
      --muted: #7B8794;
      --radius: 12px;
    }

    * {
      box-sizing: border-box
    }

    body {
      margin: 0;
      font-family: Inter, Roboto, system-ui, -apple-system, "Segoe UI", Arial;
      background: linear-gradient(180deg, #f6f8fb 0, #fff 100%);
      color: var(--black);
      -webkit-font-smoothing: antialiased;
      padding: 18px;
    }

    .container {
      max-width: 720px;
      margin: 0 auto
    }

    .card {
      background: var(--white);
      border-radius: 14px;
      padding: 12px;
      box-shadow: 0 6px 20px rgba(21, 23, 27, 0.06)
    }

    .header {
      display: flex;
      gap: 12px;
      align-items: center
    }

    .back {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(37, 99, 235, 0.08);
      color: var(--accent);
      font-weight: 700
    }

    .title {
      font-weight: 700;
      font-size: 16px
    }

    .subtitle {
      font-size: 13px;
      color: var(--muted);
      margin-top: 6px
    }

    .search {
      margin-top: 12px;
      display: flex;
      gap: 8px;
      align-items: center
    }

    .input {
      flex: 1;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid #eef2ff;
      font-size: 15px;
      outline: none;
      box-shadow: inset 0 1px 0 rgba(0, 0, 0, 0.02);
    }

    .btn {
      padding: 10px 12px;
      border-radius: 12px;
      background: var(--accent);
      color: var(--white);
      font-weight: 700;
      border: 0;
    }

    .map-wrap {
      margin-top: 12px;
      border-radius: 12px;
      overflow: hidden;
      height: 280px
    }

    #map {
      width: 100%;
      height: 100%
    }

    .hint {
      margin-top: 8px;
      font-size: 13px;
      color: var(--muted)
    }

    .results {
      margin-top: 12px;
      max-height: 260px;
      overflow: auto
    }

    .item {
      padding: 10px;
      border-radius: 10px;
      display: flex;
      gap: 8px;
      align-items: flex-start;
      border: 1px solid rgba(21, 23, 27, 0.04);
      margin-bottom: 8px;
      background: #fff
    }

    .item .meta {
      flex: 1
    }

    .item .name {
      font-weight: 700
    }

    .item .addr {
      font-size: 13px;
      color: var(--muted);
      margin-top: 4px
    }

    .item .choose {
      background: transparent;
      border: 1px solid rgba(37, 99, 235, 0.16);
      color: var(--accent);
      padding: 8px 10px;
      border-radius: 8px;
      font-weight: 700
    }

    .selected-banner {
      margin-top: 10px;
      padding: 10px;
      border-radius: 10px;
      background: linear-gradient(90deg, rgba(37, 99, 235, 0.06), rgba(255, 255, 255, 0));
      display: flex;
      justify-content: space-between;
      align-items: center
    }

    .small {
      font-size: 13px;
      color: var(--muted)
    }

    @media (max-width:420px) {
      body {
        padding: 12px
      }

      .map-wrap {
        height: 220px
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="card" role="main" aria-labelledby="title">
      <div class="header">
        <a href="/" style="text-decoration:none;">
          <div class="back" id="backBtn" title="Назад">‹</div>
        </a>
        <div>
          <div id="title" class="title">Выбрать здание</div>
          <div class="subtitle">Найдите или отметьте здание на карте</div>
        </div>
      </div>

      <div class="search" style="margin-top:12px">
        <input id="searchInput" class="input" type="search" placeholder="Поиск по адресу или названию"
          aria-label="Поиск адреса" />
        <button id="locateBtn" class="btn" title="Мое местоположение">Моя</button>
      </div>
      <div class="hint">Коснитесь карты, чтобы установить метку. Поиск предлагает зарегистрированные здания.</div>

      <div class="map-wrap" id="mapWrap">
        <div id="map"></div>
      </div>

      <div class="selected-banner" id="selectedBanner" style="display:none">
        <div>
          <div id="selName" style="font-weight:700">Название</div>
          <div id="selAddr" class="small">Адрес</div>
        </div>
        <div>
          <button id="confirmBtn" class="btn" style="padding:8px 12px">Подтвердить</button>
        </div>
      </div>

      <div class="results" id="results"></div>

    </div>
  </div>

  <!-- Leaflet -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-o9N1j8kLkQm7gQp2K4g9Q2s0p3y5a3m3F3B9xgQ0h0M=" crossorigin=""></script>

  <script>
    /* Config */
    const BUILDINGS_API = '/api/buildings?q='; // замените на ваш endpoint поиска зданий
    const REVERSE_GEOCODE_API = '/api/reverse?lat={lat}&lng={lng}'; // необязательно
    const SELECT_CALLBACK_URL = '/select-building'; // пример POST при подтверждении

    /* UI elements */
    const mapEl = document.getElementById('map');
    const searchInput = document.getElementById('searchInput');
    const resultsEl = document.getElementById('results');
    const selectedBanner = document.getElementById('selectedBanner');
    const selName = document.getElementById('selName');
    const selAddr = document.getElementById('selAddr');
    const confirmBtn = document.getElementById('confirmBtn');
    const locateBtn = document.getElementById('locateBtn');
    const backBtn = document.getElementById('backBtn');

    /* State */
    let map, marker;
    let selected = null; // {id,name,address,lat,lng}

    /* Init map */
    map = L.map(mapEl, { zoomControl: false }).setView([55.751244, 37.618423], 12); // Москва по умолчанию
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19, attribution: '© OpenStreetMap'
    }).addTo(map);

    /* Mobile: небольшая задержка при загрузке для корректного отображения */
    setTimeout(() => map.invalidateSize(), 300);

    /* Map click: place marker & reverse geocode (optional) */
    map.on('click', async function (e) {
      const { lat, lng } = e.latlng;
      placeMarker(lat, lng);
      // Попробуем получить адрес с сервера, если есть endpoint
      try {
        const url = REVERSE_GEOCODE_API.replace('{lat}', lat).replace('{lng}', lng);
        const res = await fetch(url);
        if (res.ok) {
          const data = await res.json();
          const addr = data.address || `${lat.toFixed(5)}, ${lng.toFixed(5)}`;
          setSelected({ id: null, name: 'Выбранная точка', address: addr, lat, lng });
        } else {
          setSelected({ id: null, name: 'Выбранная точка', address: `${lat.toFixed(5)}, ${lng.toFixed(5)}`, lat, lng });
        }
      } catch (e) {
        setSelected({ id: null, name: 'Выбранная точка', address: `${lat.toFixed(5)}, ${lng.toFixed(5)}`, lat, lng });
      }
    });

    /* Place or move marker */
    function placeMarker(lat, lng) {
      if (marker) marker.setLatLng([lat, lng]);
      else {
        marker = L.marker([lat, lng], { draggable: true }).addTo(map);
        marker.on('dragend', function (ev) {
          const p = ev.target.getLatLng();
          // update selection after drag
          setSelected({ id: null, name: 'Выбранная точка', address: `${p.lat.toFixed(5)}, ${p.lng.toFixed(5)}`, lat: p.lat, lng: p.lng });
        });
      }
      map.panTo([lat, lng]);
    }

    /* Set selected object and show banner */
    function setSelected(obj) {
      selected = obj;
      selName.textContent = obj.name || '—';
      selAddr.textContent = obj.address || '';
      selectedBanner.style.display = 'flex';
    }

    /* Clear results */
    function clearResults() { resultsEl.innerHTML = ''; }

    /* Render search results list */
    function renderResults(list) {
      clearResults();
      if (!list || list.length === 0) { resultsEl.innerHTML = '<div class="small" style="padding:10px;color:var(--muted)">Ничего не найдено</div>'; return; }
      list.forEach(b => {
        const it = document.createElement('div');
        it.className = 'item';
        it.innerHTML = `
      <div style="flex:1">
        <div class="name">${escapeHtml(b.name)}</div>
        <div class="addr">${escapeHtml(b.address)}</div>
      </div>
      <div>
        <button class="choose" data-id="${b.id}">Выбрать</button>
      </div>
    `;
        resultsEl.appendChild(it);
        it.querySelector('.choose').addEventListener('click', () => {
          // center map and place marker
          placeMarker(b.lat, b.lng);
          setSelected(b);
        });
      });
    }

    /* Search input with debounce and fake/autocomplete fetch */
    let searchTimer = null;
    searchInput.addEventListener('input', function (e) {
      const q = this.value.trim();
      if (searchTimer) clearTimeout(searchTimer);
      searchTimer = setTimeout(() => performSearch(q), 300);
    });

    /* Perform search: call BUILDINGS_API?q=... expecting JSON array [{id,name,address,lat,lng}] */
    async function performSearch(q) {
      if (!q) {
        clearResults();
        return;
      }
      // show loading
      resultsEl.innerHTML = '<div class="small" style="padding:10px;color:var(--muted)">Поиск...</div>';
      try {
        const res = await fetch(BUILDINGS_API + encodeURIComponent(q));
        if (!res.ok) throw new Error('Ошибка сервера');
        const data = await res.json();
        // ожидаем data = [{id,name,address,lat,lng}, ...]
        renderResults(data || []);
      } catch (err) {
        // fallback: имитация локальных подсказок (если нет API)
        const fallback = fakeSearch(q);
        renderResults(fallback);
      }
    }

    /* Fake search (используется, если нет реального API) */
    function fakeSearch(q) {
      const db = [
        { id: 1, name: 'Городская библиотека', address: 'ул. Ленина, 10', lat: 55.7515, lng: 37.6177 },
        { id: 2, name: 'Кафе "Навигатор"', address: 'пр. Мира, 5', lat: 55.7550, lng: 37.6200 },
        { id: 3, name: 'Музей истории', address: 'ул. Тверская, 3', lat: 55.7522, lng: 37.6156 },
        { id: 4, name: 'Офис маршрутов', address: 'ул. Садовая, 8', lat: 55.7498, lng: 37.6231 }
      ];
      const ql = q.toLowerCase();
      return db.filter(d => (d.name + ' ' + d.address).toLowerCase().includes(ql)).slice(0, 8);
    }

    /* Confirm selection: POST to server or call callback */
    confirmBtn.addEventListener('click', async () => {
      if (!selected) return;
      // Пример POST c выбранным объектом (JSON)
      try {
        const res = await fetch(SELECT_CALLBACK_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(selected)
        });
        if (res.ok) {
          // ожидание ответа; по умолчанию просто уходим назад
          alert('Здание выбрано');
          history.back();
        } else {
          alert('Ошибка при сохранении выбора');
        }
      } catch (e) {
        // Если сервер недоступен — можно передать выбор через localStorage или вызвать callback
        localStorage.setItem('selectedBuilding', JSON.stringify(selected));
        alert('Выбор сохранён локально');
        history.back();
      }
    });

    /* Locate user */
    locateBtn.addEventListener('click', () => {
      if (!navigator.geolocation) { alert('Геолокация не поддерживается'); return; }
      navigator.geolocation.getCurrentPosition((pos) => {
        const lat = pos.coords.latitude, lng = pos.coords.longitude;
        placeMarker(lat, lng);
        setSelected({ id: null, name: 'Мое местоположение', address: `${lat.toFixed(5)}, ${lng.toFixed(5)}`, lat, lng });
      }, (err) => {
        alert('Не удалось определить местоположение');
      });
    });

    /* Escape HTML helper */
    function escapeHtml(s) { return String(s || '').replace(/[&<>"']/g, (m) => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m])); }

    /* Back button */
    backBtn.addEventListener('click', () => history.back());

    /* Optional: if URL contains ?lat=..&lng=.. center map */
    (function initFromQuery() {
      const params = new URLSearchParams(location.search);
      const lat = parseFloat(params.get('lat')), lng = parseFloat(params.get('lng'));
      if (lat && lng) {
        map.setView([lat, lng], 16);
        placeMarker(lat, lng);
        setSelected({ id: null, name: 'Переданная точка', address: `${lat.toFixed(5)}, ${lng.toFixed(5)}`, lat, lng });
      }
    })();
  </script>
</body>

</html>